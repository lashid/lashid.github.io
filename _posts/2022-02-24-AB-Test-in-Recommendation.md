---
layout: post
categories: posts
title: AB Test Architecture in Recommendation System.
subtitle: E-commerce Recommendation
tags: [Recommendation System]
date-string: FEBRUARY 24, 2022
---

*** E-Commerce 추천 시스템에서 AB Test Architecture 를 구현하며 발생한 이슈를 정리해보았다.

* A, B 고객군을 나누는 방법은 여러가지가 있을 수 있으며, 서비스 및 개발 환경에 따라 적절한 방식을 선택해야 한다.

* 각 모듈별로 기능을 분리해 놓는 것이 중요하다. 모듈별 Dependecy 가 존재하게 될 경우, A 모델과 B 모델을 분리하는데 어려움이 생길 수 있다.

## Issue 1. Metric 을 위한 A, B 고객군 분류

* 우리는 CTR, CVR 을 기본 모델 Metric 으로 활용하였다. 이를 위해 우리는 고객, 세션별 노출 로그, 클릭 로그가 필요했으나, 문제는 **<u>로그에는 어떤 모델의 추천 결과인지가 남지 않았다는 사실이다.</u>**

* 또한, <u>**일별 개인화 추천 결과의 반영은 자정이 아닌, 오전 중에 이루어졌기 때문**</u>에 하루 전체로 집계하는 것도 불가능했다.

* 우리의 추천 영역은 1개가 아니었고, <u>**각 영역별로 동시에, 그리고 다른 고객에 대해 AB Test 를 진행할 수 있는 구조**</u>를 만들어야 했다.

*** 그래서 우리는 다음과 같이 고객군을 분류할 수 밖에 없었다.

* AB Test 기간 내에 <u>**같은 고객은 같은 모델의 추천 결과만 제공**</u>받아야 한다.

* 추천 <u>**영역별로 A, B 고객군에 대한 정보를 DB에 저장**</u>해야 한다.

그래서 위와 같이 고객군을 분류하는 모듈을 추천 일배치 맨 앞에 추가하였다.

## Issue 2. Module에 대한 Dependency 제거.

* 추천 서비스의 배치는 보통 전처리, 예측, 후처리의 과정을 거친다. 따라서 AB Test 를 위해서는 배치 내에 <u>**A, B Model 별로 각각 전처리, 예측, 후처리 Module**</u>을 따로 만들어 주어야 한다.

* 다만 우리는 추천 영역별로 <u>**Dependency 가 존재**</u>하는 부분이 있어서, 일단 따로 만들어두되, 연관성이 있는 부분에 대해서는 또 따로 구현이 필요했다.

* 또한 서비스를 제공하고 있다보니, 시간의 문제에 자유로울 수 없어서, 각 영역별 A, B 대상 고객군에 대해서만 추천 Inference를 진행하고, <u>**나머지 고객들에 대해서는 진행하지 않아야**</u> 시간 소요를 줄일 수 있다.



그래서 따로 뗄 수 있는 작업들은 모두 따로 떼고, 연결해야 하는 작업들은 모두 연결했다.

적어놓고 보니, 별 거 없어 보이지만 생각보다 머리 아픈 일이었다.

이렇게 AB Test 구조를 만들어놓았으니, 추후에 어떤 모델이든지 새롭게 반영 및 테스트를 할 수 있을 것이다. (ex. Multitask Learning, GNN 등)
